<!doctype html>
<html lang="en">

<head>
  <base href="/components/routing-web-component/test/unit/">
  </base>

  <meta charset="utf-8">
  <title>Tests</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- WCT deps -->
  <!-- <script src="../../node_modules/chai/chai.js"></script>
    <script src="../../node_modules/stacky/browser.js"></script>
    <script src="../../node_modules/web-component-tester/browser.js"></script> -->

  <!-- Stand alone deps -->
  <script src="../../node_modules/chai/chai.js"></script>
  <script src="../../node_modules/sinon/pkg/sinon.js"></script>
  <script src="../../node_modules/mocha/mocha.js"></script>

  <!-- Scripts being tested -->
  <script src="../../src/routes-router.js"></script>
  <script src="../../src/routes-route.js"></script>
  <script src="../../src/routes-outlet.js"></script>
</head>

<body>
  // TODO configure router to ignore this
  <a href="/components/routing-web-component/test/unit/index.html">rerun</a>
  <div id="mocha">
    <p><a href=".">Index</a></p>
  </div>
  <div id="messages"></div>
  <div id="fixtures"></div>

  <!-- Test set up -->
  <a-router id="router-a">
    <a-outlet id="outletA"></a-outlet>
    <a-route path="/template" id="template-route"><template>Hello Template</template></a-route>
    <a-route path="/template"><template>Only hit if template route cancelled</template></a-route>
    <a-route path="/webcomponent" import='./test-dummy.js' element="test-dummy"></a-route>
    <a-route path="/nested">
      <template>
        <p>Content with nested router</p>
        <a-router>
          <a-outlet id="outletB"></a-outlet>
          <a-route path="/template_nested"><template>Hello Nested</template></a-route>
          <a-route path="/webcomponent_nested" import='./test-dummy.js' element="test-dummy"></a-route>
          <a-route path="/nested2/:param1">
            <template>
              <p>Nested router with data</p>
              <a-router>
                <a-outlet id="outletC"></a-outlet>
                <a-route id="route-nested-component" path="/webcomponent-data2/:requiredParam" import='./test-dummy.js' element="test-dummy"></a-route>
              </a-route>
            </template>
          </a-route>
          <a-route id="catch-all" path='*'><template>catach all - NotFound1</template></a-route>
        </a-route>
      </template>
    </a-route>
    <a-route path="/webcomponent-data1/:requiredParam" import='./test-dummy.js' element="test-dummy"></a-route>
    <a-route path="/webcomponent-data2/:optionalParam?" import='./test-dummy.js' element="test-dummy"></a-route>
    <a-route path="/webcomponent-data3/:atLeastOneParam+" import='./test-dummy.js' element="test-dummy"></a-route>
    <a-route path="/webcomponent-data4/:anyNumOfParam*" import='./test-dummy.js' element="test-dummy"></a-route>
    <a-route path="/webcomponent-data5/:firstParam/:secondParam" import='./test-dummy.js' element="test-dummy"></a-route>
    <a-route id="catch-all" path='*'><template>catach all - NotFound2</template></a-route>
  </a-router>

  <template id="auxiliary-routing">
    <a-router id="routerb">
      <a-outlet id="main"></a-outlet>
      <a-route path='/main'>
        <template>
            <a-router>
                <a-outlet id="main_view1"></a-outlet>
                <a-route path='/main_view1/:param'>
                  <template>Main View 1</template>
                </a-route>
                <a-route path='/main_view2'>
                  <template>Main View 2</template>
                </a-route>
            </a-router>
            <a-router>
                <a-outlet id="main2_view1"></a-outlet>
                <a-route path='/main2_view1/:param2'>
                  <template>Main2 View 1</template>
                </a-route>
            </a-router>
        </template>
      </a-route>
    </a-router>
    <a-router id="routerc">
        <a-outlet id="sec"></a-outlet>
        <a-route path='/secondary'>
          <template>
              <a-router>
                <a-outlet id="sec_v1"></a-outlet>
                <a-route path='/sec_view1/:param'>
                  <template>Sec View 1</template>
                </a-route>
                <a-route path='/sec_view2'>
                  <template>Sec View 2</template>
                </a-route>
              </a-router>
              <a-router>
                <a-outlet id="sec_v2"></a-outlet>
                <a-route path='/secondary2_view1/:param3'>
                  <template>Sec2 View 1</template>
                </a-route>
              </a-router>
          </template>
        </a-route>
      </a-router>
  </template>

  <!-- Test suite -->
  <script>
    mocha.setup('bdd');
    let expect = chai.expect;
    var outlet = document.getElementById('outletA');

    var clickAndTest = function (linkDetails, expectedTextOrHtmlContent, done, outletId) {
      let link = document.createElement('A');
      link.href = linkDetails.href;
      linkDetails.target && (link.target = linkDetails.target);
      document.body.appendChild(link);
      console.group('test: ' + linkDetails.href)
      document.body.addEventListener("onOutletUpdated", function (event) {
        console.log('outlet updated: ' + event.target.id + '-----' + event.target.innerText);
        if (!outletId || outletId === event.target.id) {
          if (expectedTextOrHtmlContent instanceof Function)
            expectedTextOrHtmlContent(event.target);
          else
            expect(outlet.innerHTML).to.contains(expectedTextOrHtmlContent);
          document.body.removeEventListener("onOutletUpdated", arguments.callee);
          link.remove();
          console.log('call done for ' + linkDetails.href);
          console.groupEnd();
          done && done();
        }
      });
      link.click();
    };

    describe('routes-router', function () {
      describe('simple flat', function () {
        it('template based route works', function (done) {
          clickAndTest({ href: "template" }, 'Hello Template', done);
        });

        it('web component based route works with import', function (done) {
          clickAndTest({ href: "webcomponent" }, '<test-dummy><p>Test Element</p></test-dummy>', done);
        });

        it('nomatch should hit catch all', function (done) {
          clickAndTest({ href: "nomatch" }, 'catach all - NotFound2', done);
        });

        it('404 if no match and no catch all', function (done) {
          var route = document.getElementById('catch-all');
          route.setAttribute('path', 'other');
          clickAndTest(
            { href: "exception" },
            (outlet) => {
              expect(outlet.innerHTML).to.contain('404');
              route.setAttribute('path', '*');
            },
            done);
        });

        // TODO
        // it('only white listed routes should match', function (done) {
        //   var route = document.getElementById('catch-all');
        //   route.setAttribute('path', 'other');
        //   clickAndTest(
        //     { href: "exception" },
        //     (outlet) => {
        //       expect(outlet.innerHTML).to.contain('404');
        //       route.setAttribute('path', '*');
        //     },
        //     done);
        // });

        it('shouldn\'t handle different base urls', function (done) {
          clickAndTest({ href: "/template" }, 'catach all - NotFound2', done);
        });

        it('absolute path should match', function (done) {
          clickAndTest({ href: "/components/routing-web-component/test/unit/template" }, 'Hello Template', done);
        });
      });

      describe('auxiliary routing', function(){
        it('Should route auxiliary', function(done) {
          let routerA = document.getElementById('router-a');
          let auxiliaryRouting = document.getElementById('auxiliary-routing').content.cloneNode(true);
          routerA.parentNode.insertBefore(auxiliaryRouting, routerA.nextSibling);
          clickAndTest(
            { href: "template::main/(main_view1/:10::main2_view1/:99)::secondary/(sec_view1/:54::secondary2_view1/:43)" },
            'Hello Template', 
            function(){
              setTimeout(function(){
                expect(document.getElementById('router-a').innerText)
                  .to.equal('Hello Template ');
                expect(document.getElementById('routerb').innerText)
                  .to.equal('Main View 1 Main2 View 1 ');
                expect(document.getElementById('routerc').innerText)
                  .to.equal('Sec View 1 Sec2 View 1');

                document.getElementById('routerb').remove();
                document.getElementById('routerc').remove();
                done();
                }, 200);
           });
        });
      });
      
      describe('nested routes', function() {
        it('should match nested', function(done) {
          clickAndTest({ href: "nested/webcomponent_nested" }, '<test-dummy><p>Test Element</p></test-dummy>', done, 'outletB');
        });

        describe('with data', function() {
          it('should work with nested data', function(done){
            clickAndTest(
              { href: 'nested/nested2/value1/webcomponent-data2/value2' }, 
              'Test Element value2', 
              done,
              'outletC');
          });
        });
      });

      describe('data', function() {
        it('should require data', function(done) {
          clickAndTest(
            { href: 'webcomponent-data1/paramValue1' },
            '<test-dummy requiredparam="paramValue1"><p>Test Element paramValue1</p></test-dummy>',
            done);
        });

        it('supports optional data', function(done) {
          clickAndTest(
            { href: 'webcomponent-data2' },
            '<test-dummy optionalparam=""><p>Test Element</p></test-dummy>',
            done);
        });

        it('supports one or more data', function(done) {
          clickAndTest(
            { href: 'webcomponent-data3/paramValue1' },
            '<test-dummy atleastoneparam="paramValue1"><p>Test Element</p></test-dummy>',
            done);
        });

        it('supports zero or more data', function(done) {
          clickAndTest(
            { href: 'webcomponent-data4/paramValue1' },
            '<test-dummy anynumofparam="paramValue1"><p>Test Element</p></test-dummy>',
            done);
        });

        it('supports multiple data params', function(done) {
          clickAndTest(
            { href: 'webcomponent-data5/paramValue1/paramVlaue2' },
            '<test-dummy firstparam="paramValue1" secondparam="paramVlaue2"><p>Test Element</p></test-dummy>',
            done);
        });
      });

      describe('Route Caching', function() {
        it('will not update', function(done) {
          var check = function() {
            clickAndTest(
              { href: 'nested/nested2/value1/webcomponent-data2/value2' },
              function(outlet){ 
                expect(outlet.getAttribute('test')).to.equal('123');
              },
              done,
              'outletC');
            };
          clickAndTest(
              { href: 'nested/nested2/value1/webcomponent-data2/value3' },
              function(outlet){
                outlet.setAttribute('test', '123');
              },
              check,
              'outletC');
        });

        it('will update', function(done) {
          var check = function() {
            clickAndTest(
              { href: 'nested/nested2/value1/webcomponent-data2/value2' }, 
              function(outlet){ expect(outlet.getAttribute('test')).not.equal('123'); }, 
              done,
              'outletC');
            };
          clickAndTest(
              { href: 'nested/nested2/value2/webcomponent-data2/value3' }, 
              function(outlet){ outlet.setAttribute('test', '123'); }, 
              check,
              'outletC');
        });
      });

      describe('Route Guards', function() {
        it('will not leave', function(done) {
          var check = function() {
            document.body.addEventListener('onRouteLeave', function(event) {
              document.body.removeEventListener('onRouteLeave', arguments.callee);
              event.preventDefault();
              document.body.addEventListener('onRouteCancelled', function(event) {
                document.body.removeEventListener('onRouteCancelled', arguments.callee);
                console.groupEnd();
                done();
              });
            });
            clickAndTest(
              { href: 'nested/nested2/value2/webcomponent-data2/value2' }, 
              function(outlet){ }, 
              done,
              'outletC');
            };
          clickAndTest(
              { href: 'nested/nested2/value1/webcomponent-data2/value3' }, 
              function(outlet){ outlet.setAttribute('test', '123'); }, 
              check,
              'outletC');
        });
      });

      describe('Router Events', function() {
        // it('should fire onRouterAdded', function(done) {
          
        // });
        // it('should fire onRouteCancelled', function(done) {
          
        // });
      });

      describe('Route Events', function() {
        // it('should fire onRouteLeave', function(done) {
        //   clickAndTest({ href: 'nested/template_nested' }, 'Hello Nested', done);
        // });

        it('should cancel match with onRouteMatch', function(done) {
          var templateRoute = document.getElementById('template-route');
          templateRoute.addEventListener('onRouteMatch', function(event) {
            templateRoute.removeEventListener('onRouteMatch', arguments.callee);
            event.preventDefault();
          });
          clickAndTest({ href: 'template' }, 'Only hit if template route cancelled', done);
        });
      });

      describe('Outlet Events', function() {
        // it('should match nested', function(done) {
        //   clickAndTest({ href: 'nested/template_nested' }, 'Hello Nested', done);
        // });
      });

      // describe('test hash routing', function() {
      //   it('should match', function(done) {
      //     clickAndTest({ href: 'nested/template_nested' }, 'Hello Nested');
      //   });
      // });
    });

    describe('routes-route', function () {
      describe('route matching', function () {
        // it('full matches', function () {

        // });
      });
    });

    mocha.run();
  </script>
</body>

</html>